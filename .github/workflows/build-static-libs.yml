name: Build Static Libraries

on:
  workflow_dispatch:
    inputs:
      faiss_version:
        description: 'FAISS version tag (e.g., v1.13.2)'
        required: true
        default: 'v1.13.2'
      platforms:
        description: 'Platforms to build (comma-separated: linux-amd64,linux-arm64,darwin-amd64,darwin-arm64,windows-amd64 or "all")'
        required: true
        default: 'all'

jobs:
  build-linux-amd64:
    if: contains(github.event.inputs.platforms, 'linux-amd64') || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libopenblas-dev \
            libomp-dev

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh linux-amd64 ${{ github.event.inputs.faiss_version }}

      - name: Verify library
        run: |
          ls -lh libs/linux_amd64/
          file libs/linux_amd64/libfaiss.a
          nm -g libs/linux_amd64/libfaiss.a | grep -i faiss | head -10

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-linux-amd64
          path: libs/linux_amd64/
          retention-days: 90

  build-linux-arm64:
    if: contains(github.event.inputs.platforms, 'linux-arm64') || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Docker for ARM64
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            arm64v8/ubuntu:24.04 \
            bash -c "
              apt-get update && \
              apt-get install -y build-essential cmake git libopenblas-dev libomp-dev && \
              chmod +x scripts/build_static_lib.sh && \
              ./scripts/build_static_lib.sh linux-arm64 ${{ github.event.inputs.faiss_version }}
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-linux-arm64
          path: libs/linux_arm64/
          retention-days: 90

  build-darwin-amd64:
    if: contains(github.event.inputs.platforms, 'darwin-amd64') || github.event.inputs.platforms == 'all'
    runs-on: macos-15-intel  # Intel Mac

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake openblas libomp

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh darwin-amd64 ${{ github.event.inputs.faiss_version }}

      - name: Verify library
        run: |
          ls -lh libs/darwin_amd64/
          file libs/darwin_amd64/libfaiss.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-darwin-amd64
          path: libs/darwin_amd64/
          retention-days: 90

  build-darwin-arm64:
    if: contains(github.event.inputs.platforms, 'darwin-arm64') || github.event.inputs.platforms == 'all'
    runs-on: macos-14  # M1 Mac

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake openblas libomp

      - name: Build FAISS static library
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh darwin-arm64 ${{ github.event.inputs.faiss_version }}

      - name: Verify library
        run: |
          ls -lh libs/darwin_arm64/
          file libs/darwin_arm64/libfaiss.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-darwin-arm64
          path: libs/darwin_arm64/
          retention-days: 90

  build-windows-amd64:
    if: contains(github.event.inputs.platforms, 'windows-amd64') || github.event.inputs.platforms == 'all'
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Install vcpkg dependencies
        run: |
          vcpkg install openblas:x64-windows lapack:x64-windows
          vcpkg integrate install

      - name: Build FAISS static library
        shell: bash
        run: |
          chmod +x scripts/build_static_lib.sh
          ./scripts/build_static_lib.sh windows-amd64 ${{ github.event.inputs.faiss_version }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-static-windows-amd64
          path: libs/windows_amd64/
          retention-days: 90

  # Collect and upload combined artifacts
  collect-artifacts:
    needs: [build-linux-amd64, build-linux-arm64, build-darwin-amd64, build-darwin-arm64, build-windows-amd64]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: libs-artifacts

      - name: Show downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lR libs-artifacts/

      - name: Create combined artifact with all platforms
        run: |
          mkdir -p combined-static-libs

          # Copy all platform artifacts into one directory
          for platform in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64 windows-amd64; do
            if [ -d "libs-artifacts/faiss-static-$platform" ]; then
              echo "Adding $platform..."
              cp -r "libs-artifacts/faiss-static-$platform" "combined-static-libs/"
            fi
          done

          # Show what we have
          echo "=== Combined artifact contents ==="
          tree -L 2 combined-static-libs/ || ls -lR combined-static-libs/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-static-libraries
          path: combined-static-libs/
          retention-days: 90

      - name: Create installation instructions
        run: |
          cat > combined-static-libs/INSTALL.md << 'EOF'
          # Manual Installation Instructions

          Download the "all-static-libraries" artifact from GitHub Actions and extract it.

          ## File Mapping

          For each platform, copy the following files to the libs/ directory:

          ### Linux AMD64
          ```bash
          cp faiss-static-linux-amd64/libfaiss.a libs/linux_amd64/
          cp faiss-static-linux-amd64/libfaiss_c.a libs/linux_amd64/
          cp faiss-static-linux-amd64/build_info.json libs/linux_amd64/
          cp faiss-static-linux-amd64/checksums.txt libs/linux_amd64/
          cp -r faiss-static-linux-amd64/include libs/linux_amd64/
          ```

          ### Linux ARM64
          ```bash
          cp faiss-static-linux-arm64/libfaiss.a libs/linux_arm64/
          cp faiss-static-linux-arm64/libfaiss_c.a libs/linux_arm64/
          cp faiss-static-linux-arm64/build_info.json libs/linux_arm64/
          cp faiss-static-linux-arm64/checksums.txt libs/linux_arm64/
          cp -r faiss-static-linux-arm64/include libs/linux_arm64/
          ```

          ### Darwin AMD64 (Intel Mac)
          ```bash
          cp faiss-static-darwin-amd64/libfaiss.a libs/darwin_amd64/
          cp faiss-static-darwin-amd64/libfaiss_c.a libs/darwin_amd64/
          cp faiss-static-darwin-amd64/build_info.json libs/darwin_amd64/
          cp faiss-static-darwin-amd64/checksums.txt libs/darwin_amd64/
          cp -r faiss-static-darwin-amd64/include libs/darwin_amd64/
          ```

          ### Darwin ARM64 (Apple Silicon)
          ```bash
          cp faiss-static-darwin-arm64/libfaiss.a libs/darwin_arm64/
          cp faiss-static-darwin-arm64/libfaiss_c.a libs/darwin_arm64/
          cp faiss-static-darwin-arm64/build_info.json libs/darwin_arm64/
          cp faiss-static-darwin-arm64/checksums.txt libs/darwin_arm64/
          cp -r faiss-static-darwin-arm64/include libs/darwin_arm64/
          ```

          ### Windows AMD64
          ```bash
          cp faiss-static-windows-amd64/faiss.lib libs/windows_amd64/
          cp faiss-static-windows-amd64/faiss_c.lib libs/windows_amd64/
          cp faiss-static-windows-amd64/build_info.json libs/windows_amd64/
          cp faiss-static-windows-amd64/checksums.txt libs/windows_amd64/
          cp -r faiss-static-windows-amd64/include libs/windows_amd64/
          ```

          ## Quick Script

          Run this from the extracted artifact directory:

          ```bash
          #!/bin/bash
          # Assuming you're in the extracted combined-static-libs/ directory
          # and your repo is at ../faiss-go/

          REPO_DIR="../faiss-go"

          # Linux AMD64
          mkdir -p "$REPO_DIR/libs/linux_amd64"
          cp faiss-static-linux-amd64/libfaiss.a "$REPO_DIR/libs/linux_amd64/"
          cp faiss-static-linux-amd64/libfaiss_c.a "$REPO_DIR/libs/linux_amd64/"
          cp faiss-static-linux-amd64/build_info.json "$REPO_DIR/libs/linux_amd64/"
          cp faiss-static-linux-amd64/checksums.txt "$REPO_DIR/libs/linux_amd64/"
          cp -r faiss-static-linux-amd64/include "$REPO_DIR/libs/linux_amd64/"

          # Linux ARM64
          mkdir -p "$REPO_DIR/libs/linux_arm64"
          cp faiss-static-linux-arm64/libfaiss.a "$REPO_DIR/libs/linux_arm64/"
          cp faiss-static-linux-arm64/libfaiss_c.a "$REPO_DIR/libs/linux_arm64/"
          cp faiss-static-linux-arm64/build_info.json "$REPO_DIR/libs/linux_arm64/"
          cp faiss-static-linux-arm64/checksums.txt "$REPO_DIR/libs/linux_arm64/"
          cp -r faiss-static-linux-arm64/include "$REPO_DIR/libs/linux_arm64/"

          # Darwin AMD64
          mkdir -p "$REPO_DIR/libs/darwin_amd64"
          cp faiss-static-darwin-amd64/libfaiss.a "$REPO_DIR/libs/darwin_amd64/"
          cp faiss-static-darwin-amd64/libfaiss_c.a "$REPO_DIR/libs/darwin_amd64/"
          cp faiss-static-darwin-amd64/build_info.json "$REPO_DIR/libs/darwin_amd64/"
          cp faiss-static-darwin-amd64/checksums.txt "$REPO_DIR/libs/darwin_amd64/"
          cp -r faiss-static-darwin-amd64/include "$REPO_DIR/libs/darwin_amd64/"

          # Darwin ARM64
          mkdir -p "$REPO_DIR/libs/darwin_arm64"
          cp faiss-static-darwin-arm64/libfaiss.a "$REPO_DIR/libs/darwin_arm64/"
          cp faiss-static-darwin-arm64/libfaiss_c.a "$REPO_DIR/libs/darwin_arm64/"
          cp faiss-static-darwin-arm64/build_info.json "$REPO_DIR/libs/darwin_arm64/"
          cp faiss-static-darwin-arm64/checksums.txt "$REPO_DIR/libs/darwin_arm64/"
          cp -r faiss-static-darwin-arm64/include "$REPO_DIR/libs/darwin_arm64/"

          # Windows AMD64
          mkdir -p "$REPO_DIR/libs/windows_amd64"
          cp faiss-static-windows-amd64/faiss.lib "$REPO_DIR/libs/windows_amd64/"
          cp faiss-static-windows-amd64/faiss_c.lib "$REPO_DIR/libs/windows_amd64/"
          cp faiss-static-windows-amd64/build_info.json "$REPO_DIR/libs/windows_amd64/"
          cp faiss-static-windows-amd64/checksums.txt "$REPO_DIR/libs/windows_amd64/"
          cp -r faiss-static-windows-amd64/include "$REPO_DIR/libs/windows_amd64/"

          echo "Done! Files copied to $REPO_DIR/libs/"
          ```

          ## Verification

          After copying, verify the structure:

          ```bash
          cd ../faiss-go
          tree libs/
          ```

          Expected structure:
          ```
          libs/
          ├── darwin_amd64/
          │   ├── libfaiss.a
          │   ├── libfaiss_c.a
          │   ├── build_info.json
          │   ├── checksums.txt
          │   └── include/
          ├── darwin_arm64/
          │   └── ...
          ├── linux_amd64/
          │   └── ...
          ├── linux_arm64/
          │   └── ...
          └── windows_amd64/
              ├── faiss.lib
              ├── faiss_c.lib
              └── ...
          ```

          ## Test the Build

          ```bash
          go build -tags=faiss_use_lib,nogpu -v ./...
          go test -tags=faiss_use_lib,nogpu -v ./...
          ```
          EOF

          echo "Created installation instructions"
