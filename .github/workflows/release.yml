name: Release

# Creates a new release with versioning based on faiss-go-bindings version.
# Version format: v{BINDINGS_VERSION}.{PATCH}
#
# The bindings version is automatically extracted from go.mod.
# Examples (if bindings is v1.13.2-2):
# - v1.13.2-2.1 (first faiss-go release for bindings v1.13.2-2)
# - v1.13.2-2.2 (second release, bug fixes)
# - v1.13.2-2.3 (third release, new features)
#
# When bindings updates to v1.13.2-3:
# - v1.13.2-3.1 (first release for new bindings)

on:
  workflow_dispatch:
    inputs:
      patch_bump:
        description: 'Patch number to release (auto-increments from last tag if empty)'
        required: false
        type: string
        default: ''
      prerelease:
        description: 'Pre-release suffix (optional, e.g., alpha, beta, rc1)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify running on main branch
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "Error: Releases can only be created from the main branch"
            echo "Current branch: $CURRENT_BRANCH"
            exit 1
          fi
          echo "Running on main branch"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install runtime dependencies
        run: |
          sudo apt-get update
          # Only need OpenMP and Fortran runtimes - OpenBLAS is statically linked
          sudo apt-get install -y libgomp1 libgfortran5

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract bindings version from go.mod
        id: bindings
        run: |
          # Extract the bindings version from go.mod
          # Example: github.com/NerdMeNot/faiss-go-bindings v1.13.2-2
          BINDINGS_VERSION=$(grep 'github.com/NerdMeNot/faiss-go-bindings' go.mod | awk '{print $2}')

          if [ -z "$BINDINGS_VERSION" ]; then
            echo "Error: Could not find faiss-go-bindings in go.mod"
            exit 1
          fi

          echo "bindings_version=$BINDINGS_VERSION" >> $GITHUB_OUTPUT
          echo "Bindings version: $BINDINGS_VERSION"

      - name: Determine next version
        id: version
        run: |
          BINDINGS_VERSION="${{ steps.bindings.outputs.bindings_version }}"

          # Find all existing tags that start with this bindings version
          # e.g., v1.13.2-2.1, v1.13.2-2.2, etc.
          EXISTING_TAGS=$(git tag -l "${BINDINGS_VERSION}.*" | sort -V)

          echo "Existing tags for bindings $BINDINGS_VERSION:"
          echo "$EXISTING_TAGS"

          if [ -n "${{ inputs.patch_bump }}" ]; then
            # User specified a patch number
            PATCH="${{ inputs.patch_bump }}"
          elif [ -z "$EXISTING_TAGS" ]; then
            # No existing tags for this bindings version, start at .1
            PATCH="1"
          else
            # Get the highest patch number and increment
            LAST_TAG=$(echo "$EXISTING_TAGS" | tail -1)
            LAST_PATCH=$(echo "$LAST_TAG" | sed "s/${BINDINGS_VERSION}\.//" | sed 's/-.*//')
            PATCH=$((LAST_PATCH + 1))
          fi

          NEXT_TAG="${BINDINGS_VERSION}.${PATCH}"

          # Add pre-release suffix if provided
          if [ -n "${{ inputs.prerelease }}" ]; then
            NEXT_TAG="${NEXT_TAG}-${{ inputs.prerelease }}"
          fi

          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT

          echo "Next version: $NEXT_TAG"

      - name: Check if tag already exists
        run: |
          if git rev-parse "${{ steps.version.outputs.next_tag }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ steps.version.outputs.next_tag }} already exists"
            exit 1
          fi
          echo "Tag ${{ steps.version.outputs.next_tag }} is available"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the last tag (any tag, not just this bindings version)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, generating full changelog"
            COMMIT_RANGE="HEAD"
          else
            echo "Generating changelog from $LAST_TAG to HEAD"
            COMMIT_RANGE="$LAST_TAG..HEAD"
          fi

          # Generate changelog from commit messages
          CHANGELOG=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --no-merges)

          # Categorize commits
          {
            echo "## What's Changed"
            echo ""

            # Features
            FEATURES=$(echo "$CHANGELOG" | grep -i "feat:" || true)
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo "$FEATURES"
              echo ""
            fi

            # Bug Fixes
            FIXES=$(echo "$CHANGELOG" | grep -i "fix:" || true)
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # Performance
            PERF=$(echo "$CHANGELOG" | grep -i "perf:" || true)
            if [ -n "$PERF" ]; then
              echo "### Performance"
              echo "$PERF"
              echo ""
            fi

            # Documentation
            DOCS=$(echo "$CHANGELOG" | grep -i "docs:" || true)
            if [ -n "$DOCS" ]; then
              echo "### Documentation"
              echo "$DOCS"
              echo ""
            fi

            # Other changes
            OTHER=$(echo "$CHANGELOG" | grep -viE "feat:|fix:|perf:|docs:" || true)
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER"
              echo ""
            fi

            echo "---"
            echo ""
            echo "**Bindings Version:** ${{ steps.bindings.outputs.bindings_version }}"
            echo ""

          } > RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Run tests
        env:
          CGO_LDFLAGS_ALLOW: ".*"
        run: |
          echo "Running tests before release..."
          go test -v -timeout 10m ./...

      - name: Run linting
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.62.2
          args: --timeout=5m

      - name: Create and push tag
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const tag = '${{ steps.version.outputs.next_tag }}';
            const releaseNotes = fs.readFileSync('RELEASE_NOTES.md', 'utf8');

            const isPrerelease = tag.includes('-alpha') || tag.includes('-beta') || tag.includes('-rc');

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: releaseNotes,
              draft: false,
              prerelease: isPrerelease
            });

            console.log(`Created release: ${release.data.html_url}`);

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released version:** ${{ steps.version.outputs.next_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Info" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bindings Version | ${{ steps.bindings.outputs.bindings_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Patch | ${{ steps.version.outputs.patch }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "go get github.com/NerdMeNot/faiss-go@${{ steps.version.outputs.next_tag }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          cat RELEASE_NOTES.md >> $GITHUB_STEP_SUMMARY
