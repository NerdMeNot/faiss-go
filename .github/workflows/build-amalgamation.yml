name: Build FAISS Amalgamation

on:
  workflow_dispatch:
    inputs:
      faiss_version:
        description: 'FAISS version tag (e.g., v1.8.0)'
        required: true
        default: 'v1.8.0'

jobs:
  build-amalgamation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            python3 \
            libopenblas-dev \
            libomp-dev

      - name: Build FAISS amalgamation
        run: |
          chmod +x scripts/build_amalgamation.sh
          ./scripts/build_amalgamation.sh ${{ github.event.inputs.faiss_version || 'v1.8.0' }}

      - name: Verify amalgamation files
        run: |
          ls -lh faiss/
          echo "Checking for required files..."
          test -f faiss/faiss.cpp || exit 1
          test -f faiss/faiss.h || exit 1
          echo "âœ“ Amalgamation files created successfully"

      - name: Get file sizes
        run: |
          echo "Amalgamation file sizes:"
          du -h faiss/faiss.cpp
          du -h faiss/faiss.h

      - name: Create artifact
        uses: actions/upload-artifact@v4
        with:
          name: faiss-amalgamation-${{ github.event.inputs.faiss_version || 'v1.8.0' }}
          path: |
            faiss/faiss.cpp
            faiss/faiss.h
            faiss/BUILD_INFO.txt
          retention-days: 90

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "feat: Add FAISS amalgamation ${{ github.event.inputs.faiss_version || 'v1.8.0' }}"
          title: "Add FAISS amalgamation ${{ github.event.inputs.faiss_version || 'v1.8.0' }}"
          body: |
            ## FAISS Amalgamation

            This PR adds the FAISS amalgamated source files for embedded compilation.

            **FAISS Version**: ${{ github.event.inputs.faiss_version || 'v1.8.0' }}

            ### Files Added
            - `faiss/faiss.cpp` - Amalgamated FAISS C++ implementation
            - `faiss/faiss.h` - FAISS C API header
            - `faiss/BUILD_INFO.txt` - Build metadata

            ### Build Mode
            This enables the default build mode (compile from source):
            ```bash
            go build  # Compiles FAISS from amalgamated source
            ```

            ### Testing
            - [ ] Builds successfully on Linux
            - [ ] Builds successfully on macOS
            - [ ] Builds successfully on Windows
            - [ ] All tests pass

            Generated by GitHub Actions workflow.
          branch: faiss-amalgamation-${{ github.event.inputs.faiss_version || 'v1.8.0' }}
          delete-branch: true
