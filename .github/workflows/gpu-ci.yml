name: GPU CI

on:
  workflow_dispatch:  # Manual trigger only - run on-demand for GPU testing

jobs:
  gpu-test:
    name: Build and Test with GPU
    runs-on: ubuntu-latest
    # Uncomment if you have GPU runners:
    # runs-on: [self-hosted, linux, gpu]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Check CUDA availability
      run: |
        if command -v nvidia-smi &> /dev/null; then
          echo "CUDA available"
          nvidia-smi
        else
          echo "CUDA not available - skipping GPU tests"
          echo "GPU_AVAILABLE=false" >> $GITHUB_ENV
          exit 0
        fi

    - name: Install CUDA dependencies
      if: env.GPU_AVAILABLE != 'false'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libopenblas-dev \
          libgomp1 \
          libomp-dev \
          cuda-toolkit-12-3

    - name: Build and install FAISS with GPU
      if: env.GPU_AVAILABLE != 'false'
      run: |
        cd /tmp
        wget https://github.com/facebookresearch/faiss/archive/refs/tags/v1.13.2.tar.gz
        tar -xzf v1.13.2.tar.gz
        cd faiss-1.13.2

        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DFAISS_ENABLE_GPU=ON \
          -DFAISS_ENABLE_PYTHON=OFF \
          -DFAISS_ENABLE_C_API=ON \
          -DBUILD_TESTING=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_CUDA_ARCHITECTURES="70;75;80;86;89;90" \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          .

        make -C build -j$(nproc)
        sudo make -C build install
        sudo ldconfig

    - name: Build Go project with GPU
      if: env.GPU_AVAILABLE != 'false'
      env:
        CGO_LDFLAGS: "-L/usr/local/lib -lfaiss -lfaiss_gpu -lcudart -lcublas -lgomp -lstdc++ -lm -lopenblas"
        CGO_CFLAGS: "-I/usr/local/include -DFAISS_GPU"
        CGO_LDFLAGS_ALLOW: ".*"
        LD_LIBRARY_PATH: "/usr/local/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
      run: |
        go build -tags=gpu -v ./...

    - name: Run GPU tests
      if: env.GPU_AVAILABLE != 'false'
      env:
        CGO_LDFLAGS: "-L/usr/local/lib -lfaiss -lfaiss_gpu -lcudart -lcublas -lgomp -lstdc++ -lm -lopenblas"
        CGO_CFLAGS: "-I/usr/local/include -DFAISS_GPU"
        CGO_LDFLAGS_ALLOW: ".*"
        LD_LIBRARY_PATH: "/usr/local/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
      run: |
        go test -tags=gpu -v -timeout 10m ./...

    - name: Run GPU benchmarks
      if: env.GPU_AVAILABLE != 'false'
      env:
        CGO_LDFLAGS: "-L/usr/local/lib -lfaiss -lfaiss_gpu -lcudart -lcublas -lgomp -lstdc++ -lm -lopenblas"
        CGO_CFLAGS: "-I/usr/local/include -DFAISS_GPU"
        CGO_LDFLAGS_ALLOW: ".*"
        LD_LIBRARY_PATH: "/usr/local/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
      run: |
        go test -tags=gpu -v -bench=. -benchtime=3s -run=^$ ./... | tee benchmark-results.txt

    - name: Upload benchmark results
      if: env.GPU_AVAILABLE != 'false'
      uses: actions/upload-artifact@v4
      with:
        name: gpu-benchmark-results
        path: benchmark-results.txt
