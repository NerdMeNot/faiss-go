name: Continuous Benchmarking

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode: quick or comprehensive'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - quick
          - comprehensive
      benchtime:
        description: 'Benchmark time (e.g., 1s, 5s, 10s)'
        required: false
        default: '5s'

jobs:
  # Fast benchmarks - runs when mode=quick
  benchmark-quick:
    name: Quick Benchmarks (Go ${{ matrix.go-version }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.mode == 'quick' || github.event.inputs.mode == ''

    strategy:
      fail-fast: false
      matrix:
        # Test recent Go versions (update as new versions release)
        go-version: ['1.23', '1.24', '1.25']
        arch: ['amd64', 'arm64']
        include:
          - arch: amd64
            os: ubuntu-latest
          - arch: arm64
            os: ubuntu-24.04-arm

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libopenblas-dev libgomp1 libomp-dev

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-${{ matrix.arch }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-go-${{ matrix.go-version }}-

    - name: Run quick benchmarks (amalgamation build)
      env:
        CGO_LDFLAGS: "-lopenblas -lgomp -lstdc++ -lm"
      timeout-minutes: 15
      run: |
        # Run subset of fast benchmarks with short benchtime
        go test -tags nogpu \
          -bench='BenchmarkIndexFlatL2|BenchmarkIndexIVFFlat_Search|BenchmarkIndexHNSW' \
          -benchmem \
          -benchtime=1s \
          -run=^$ \
          -timeout=10m \
          ./... | tee benchmark-quick-${{ matrix.go-version }}-${{ matrix.arch }}.txt

    - name: Upload quick benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-quick-go${{ matrix.go-version }}-${{ matrix.arch }}-${{ github.sha }}
        path: benchmark-quick-${{ matrix.go-version }}-${{ matrix.arch }}.txt
        retention-days: 30

  # Comprehensive benchmarks - runs when mode=comprehensive
  benchmark-comprehensive:
    name: Comprehensive Benchmarks (Go ${{ matrix.go-version }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.mode == 'comprehensive'

    strategy:
      fail-fast: false
      matrix:
        # Test all supported Go versions (update as new versions release)
        go-version: ['1.21', '1.22', '1.23', '1.24', '1.25']
        arch: ['amd64', 'arm64']
        include:
          - arch: amd64
            os: ubuntu-latest
          - arch: arm64
            os: ubuntu-24.04-arm

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libopenblas-dev libgomp1 libomp-dev

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-${{ matrix.arch }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-go-${{ matrix.go-version }}-

    - name: Run comprehensive benchmarks
      env:
        CGO_LDFLAGS: "-lopenblas -lgomp -lstdc++ -lm"
        BENCHTIME: ${{ github.event.inputs.benchtime || '5s' }}
      timeout-minutes: 30
      run: |
        go test -tags nogpu \
          -bench=. \
          -benchmem \
          -benchtime=$BENCHTIME \
          -run=^$ \
          -timeout=25m \
          ./... | tee benchmark-comprehensive-${{ matrix.go-version }}-${{ matrix.arch }}.txt

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: Go ${{ matrix.go-version }} Benchmark (${{ matrix.arch }})
        tool: 'go'
        output-file-path: benchmark-comprehensive-${{ matrix.go-version }}-${{ matrix.arch }}.txt
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        alert-threshold: '150%'
        comment-on-alert: true
        fail-on-alert: false
        alert-comment-cc-users: '@owner'
      continue-on-error: true

    - name: Upload comprehensive benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-comprehensive-go${{ matrix.go-version }}-${{ matrix.arch }}-${{ github.sha }}
        path: benchmark-comprehensive-${{ matrix.go-version }}-${{ matrix.arch }}.txt
        retention-days: 90

  # Comparison job - compares results across Go versions and architectures
  benchmark-compare:
    name: Compare Benchmark Results
    runs-on: ubuntu-latest
    needs: benchmark-comprehensive
    if: github.event.inputs.mode == 'comprehensive'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install benchstat
      run: go install golang.org/x/perf/cmd/benchstat@latest

    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        path: ./benchmarks
        pattern: benchmark-comprehensive-*

    - name: Generate comparison report
      run: |
        echo "# Benchmark Comparison Report" > comparison.md
        echo "" >> comparison.md
        echo "Generated: $(date -u)" >> comparison.md
        echo "" >> comparison.md

        # Compare AMD64 vs ARM64 for Go 1.23
        if [ -f "benchmarks/benchmark-comprehensive-go1.23-amd64-${{ github.sha }}/benchmark-comprehensive-1.23-amd64.txt" ] && \
           [ -f "benchmarks/benchmark-comprehensive-go1.23-arm64-${{ github.sha }}/benchmark-comprehensive-1.23-arm64.txt" ]; then
          echo "## AMD64 vs ARM64 (Go 1.23)" >> comparison.md
          echo '```' >> comparison.md
          benchstat \
            "benchmarks/benchmark-comprehensive-go1.23-amd64-${{ github.sha }}/benchmark-comprehensive-1.23-amd64.txt" \
            "benchmarks/benchmark-comprehensive-go1.23-arm64-${{ github.sha }}/benchmark-comprehensive-1.23-arm64.txt" \
            >> comparison.md || echo "Comparison failed" >> comparison.md
          echo '```' >> comparison.md
          echo "" >> comparison.md
        fi

        # Compare Go versions on AMD64
        if [ -f "benchmarks/benchmark-comprehensive-go1.21-amd64-${{ github.sha }}/benchmark-comprehensive-1.21-amd64.txt" ] && \
           [ -f "benchmarks/benchmark-comprehensive-go1.25-amd64-${{ github.sha }}/benchmark-comprehensive-1.25-amd64.txt" ]; then
          echo "## Go 1.21 vs Go 1.25 (AMD64)" >> comparison.md
          echo '```' >> comparison.md
          benchstat \
            "benchmarks/benchmark-comprehensive-go1.21-amd64-${{ github.sha }}/benchmark-comprehensive-1.21-amd64.txt" \
            "benchmarks/benchmark-comprehensive-go1.25-amd64-${{ github.sha }}/benchmark-comprehensive-1.25-amd64.txt" \
            >> comparison.md || echo "Comparison failed" >> comparison.md
          echo '```' >> comparison.md
        fi

    - name: Upload comparison report
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-comparison-${{ github.sha }}
        path: comparison.md
        retention-days: 90

    - name: Comment comparison on commit (if schedule)
      if: github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const comparison = fs.readFileSync('comparison.md', 'utf8');

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: comparison
          });
